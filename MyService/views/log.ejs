<% include _public/header_with_nav %>
<div class="container">
    <div class="form-group">
        <% var rowItemClass = 'col-lg-3 col-md-4 col-sm-6 col-xs-12';%>
        <div class="row my-row">
            <%
            var prefix = 'log_';
            var searchItemList = [{
                text: 'id',
                id:'id',
            },{
                text: 'url',
                id:'url',
            },{
                text: 'create_date_s',
                id:'create_date_start',
            },{
                text: 'create_date_e',
                id:'create_date_end',
            },{
                text: 'guid',
                id:'guid',
            },];
            for(var i = 0;i< searchItemList.length;i++){
                var item = searchItemList[i];
            %>
                <div class="<%=rowItemClass%>">
                    <div class="input-group">
                        <span class="input-group-addon"><%=item.text%></span>
                        <input id="<%=prefix + item.id%>" type="text" class="form-control" />
                    </div>
                </div>
            <%}%>
        </div>
        <div class="row my-row">
            <div class="<%=rowItemClass%> col-lg-offset-9 col-md-offset-8 col-sm-offset-6">
                <button id="search" class="btn btn-default btn-block">
                    search
                </button>
            </div>
        </div>
    </div>
    <table id="logTable" class="table table-bordered">
        <thead>
            <tr>
                <th>id</th>
                <th>url</th>
                <th>method</th>
                <th>result</th>
                <th>code</th>
                <th>req</th>
                <th>res</th>
                <th>ip</th>
                <th>create_date</th>
                <th>remark</th>
                <th>guid</th>
            </tr>
        </thead>
        <tbody id="logList"></tbody>
        <tbody class="table-error">
            <tr><td class="text-center" colspan="100" id="logMsg"></td></tr>
        </tbody>
    </table>
    <div id="pager"></div>
</div>
<% include _public/footer_with_nav %>

<script type="text/template" id="logItem">
    <%include _template_web/logItem%>
</script>
<script type="text/javascript" src="/js/<%=env%>/my.pager.js"></script>
<script type="text/javascript">
    var logModel = {
        pager: null,
        init: function () {
            var self = this;
            self.bindEvent();
            self.pager = new my.pager({
                changeHandle: function (cb) {
                    self.query().then(function (t) {
                        cb({count: t.count});
                    }).fail(function () {
                        cb();
                    });
                }
            });
            $('#search').click();
        },
        bindEvent: function () {
            var self = this;
            $('#log_create_date_start').on('click', function() {
                var datePickerArgs = {
                    el: this,
                    //startDate: '#{%y-30}-01-01',
                    doubleCalendar: true,
                    dateFmt: 'yyyy-MM-dd',
                    minDate: '1900-01-01',
                    maxDate: '#F{$dp.$D(\'log_create_date_end\')}',
                };
                WdatePicker(datePickerArgs);
            });
            $('#log_create_date_end').on('click', function() {
                var datePickerArgs = {
                    el: this,
                    //startDate: minDate || '#{%y-30}-01-01',
                    doubleCalendar: true,
                    dateFmt: 'yyyy-MM-dd',
                    minDate: '#F{$dp.$D(\'log_create_date_start\')||\'1900-01-01\'}',
                    maxDate: '',
                };
                WdatePicker(datePickerArgs);
            });

            $('#search').on('click', function(){
                self.pager.gotoPage(1);
            });
        },
        query: function(){
            var self = this;
            var list=[{
                name: 'id',
                dom: $('#log_id'),
            }, {
                name: 'create_date_start',
                dom: $('#log_create_date_start'),
                canNotNull: true,
            },{
                name: 'create_date_end',
                dom: $('#log_create_date_end'),
            },{
                name: 'url',
                dom: $('#log_url'),
            },{
                name: 'guid',
                dom: $('#log_guid'),
            }];
            var checkRes = extend.dataCheck({list:list});
            if(!checkRes.success){
                alert(checkRes.desc);
                if(checkRes.dom)
                    checkRes.dom.focus();
                return $.Deferred().reject();
            }
            var data = checkRes.model;
            $('#logTable').removeClass('error');
            if (!data.id) data.id = null;
            data.page_index = self.pager.pageIndex;
            data.page_size = self.pager.pageSize;
            var opt = {
                url: '/log/query',
                data: data,
                myDataCheck:function() {
                }
            };
            return extend.ajax(opt).then(function(t){
                if(!t.list.length)
                        return $.Deferred().reject('No Data');
                $('#logList').empty();
                var temp = $('#logItem').html();
                $(t.list).each(function(){
                    var item = this;
                    $('#logList').append(ejs.render(temp, item));
                });
                return t;
            }).fail(function(e) {
                $('#logList').empty();
                if (e instanceof Error) e = e.message;
                if (typeof e == 'object') e = JSON.stringify(e);
                $('#logMsg').html(e);
                $('#logTable').addClass('error');
            });
        },
    }

    $(function () {
        logModel.init();
    });
</script>